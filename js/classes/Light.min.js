!function(t){var s=function(t,s){this.noCollision=!0,this.pos=s.pos,this.color=s.color||"white",this.intersects=[],this.dirty=!0,this.maxDistance=1e3,this.update=function(){if(this.dirty){this.visible=!0,this.dirty=!1;var s=t.getAllBoxSegments();s=s.filter(function(t){return Math.sqrt(Math.pow(this.pos.x-t.x1,2)+Math.pow(this.pos.y-t.y1,2))<this.maxDistance}.bind(this));var i=e(s),n=this.getAllAngles(i);this.getSortedIntersects(n,s)}}};s.prototype.getSortedIntersects=function(t,s){var e,r,h,o,a,l,c;for(this.intersects=[],e=0;e<t.length;e++){for(h=Math.cos(t[e]),o=Math.sin(t[e]),a={x1:this.pos.x,y1:this.pos.y,x2:this.pos.x+h,y2:this.pos.y+o},l=null,r=0;r<s.length;r++)c=n(a,s[r]),c&&(!l||c.param<l.param)&&(l=c);l&&(l.angle=t[e],this.intersects.push(l))}this.intersects=i(this.intersects),this.intersects=this.intersects.sort(function(t,s){return t.angle-s.angle})},s.prototype.getAllAngles=function(t){var s,i=[];for(s=0;s<t.length;s++){var e=Math.atan2(t[s].y-this.pos.y,t[s].x-this.pos.x);t[s].angle=e,i.push(e-1e-5,e,e+1e-5)}return i},s.prototype.draw=function(t){if(this.visible&&(this.visible=!1,this.dirty=!0,0!==this.intersects.length)){var s;for(t.fillStyle=this.color,t.beginPath(),t.moveTo(this.intersects[0].x,this.intersects[0].y),s=1;s<this.intersects.length;s++)t.lineTo(this.intersects[s].x,this.intersects[s].y);t.closePath(),t.fill()}};var i=function(t){var s={};return t.filter(function(t){var i=(0|t.x)+","+(0|t.y);return i in s?!1:(s[i]=!0,!0)})},e=function(t){var s=[];return t.forEach(function(t){s.push({x:t.x1,y:t.y1})}),s},n=function(t,s){var i=t.x1,e=t.y1,n=t.x2-t.x1,r=t.y2-t.y1,h=Math.sqrt(n*n+r*r),o=s.x1,a=s.y1,l=s.x2-s.x1,c=s.y2-s.y1,u=Math.sqrt(l*l+c*c);if(n/h==l/u&&r/h==c/u)return null;var y=(n*(a-e)+r*(i-o))/(l*r-c*n),f=(o+l*y-i)/n;return 0>f?null:0>y||y>1?null:{x:i+n*f,y:e+r*f,param:f}};t.Light=s}(this);